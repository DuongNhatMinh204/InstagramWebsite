<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Trang Ch·ªß - Instagram Clone</title>
    <link rel="stylesheet" href="/css/home.css">
</head>
<body>
<!-- Navigation -->
<nav class="nav-bar">
    <h1>Instagram</h1>
    <div class="nav-items">
        <span>üè† Home</span>
        <button id="openModalBtn">üí¨ Messages</button>
        <div id="chatModal" class="modal">
            <div class="modal-content">
                <span class="close">√ó</span>
                <h3>ƒêo·∫°n chat</h3>
                <input type="text" placeholder="T√¨m ki·∫øm tr√™n Messenger..." class="search-box">
                <div class="chat-list" id="chatList">
                </div>
            </div>
        </div>

        <div id="authNavButton" class="profile-dropdown-container">
        </div>
    </div>
</nav>
<!-- Modal hi·ªÉn th·ªã chi ti·∫øt ƒëo·∫°n chat v·ªõi 1 ng∆∞·ªùi -->
<div id="chatDetailModal" class="modal chat-detail-modal">
    <div class="modal-content">
        <span class="closeDetail">√ó</span>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            <img id="chatHeaderAvatar" src="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;" alt="">
            <h3 style="margin:0;"><span id="chatWithName"></span></h3>
        </div>
        <div id="chatMessages" style="height: 300px; overflow-y: scroll;"></div>
        <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button id="sendChatBtn">G·ª≠i</button>
    </div>
</div>
<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content profile-modal-content">
        <span class="closeProfile">√ó</span>
        <div class="profile-header">
            <button id="viewProfileBtn">Xem t·∫•t c·∫£ trang c√° nh√¢n</button>
        </div>
        <hr />
        <div class="profile-options">
            <div class="option">‚öôÔ∏è C√†i ƒë·∫∑t & quy·ªÅn ri√™ng t∆∞</div>
            <div class="option">‚ùì Tr·ª£ gi√∫p v√† h·ªó tr·ª£</div>
            <div class="option">üåô M√†n h√¨nh & tr·ª£ nƒÉng</div>
            <div class="option">üí¨ ƒê√≥ng g√≥p √Ω ki·∫øn</div>
            <div class="option" id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</div>
        </div>
    </div>
</div>

<div class="main-container" style="display: flex; justify-content: center; align-items: flex-start; margin-top: 85px; padding: 20px;">
    <div class="posts-feed" style="margin-right: 32px;">
        <div class="post-card">
            <form id="postForm">
                <div class="post-header">
                    <img id="currentUserAvatar" src="" class="post-avatar" alt="Avatar">
                    <label for="content"></label><textarea id="content" placeholder="What's on your mind?" style="width:100%; resize: none;"></textarea>
                </div>
                <input type="file" id="imgFile" accept="image/*">
                <img id="previewImage" src="" alt="Xem tr∆∞·ªõc ·∫£nh" style="max-width:100%; margin-top: 10px; border-radius: 8px; display: none;" />
                <button type="submit">ƒêƒÉng B√†i</button>
            </form>
        </div>
        <div id="postsContainer"></div>
    </div>
    <div class="contacts-list" style="width: 280px; margin-left: 2px; margin-top: 220px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); padding: 16px; min-height: 500px;">
        <h3 style="margin-top:0;">Ng∆∞·ªùi li√™n h·ªá</h3>
        <div id="followingsList">
            <div style="color:#888;">ƒêang t·∫£i...</div>
        </div>
    </div>
</div>

<!-- Th√™m th∆∞ vi·ªán sockjs-client v√† stompjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="/js/home.js"></script>
<script src="/js/chat.js"></script>
<script src="/js/profile.js"></script>
<script>
// hi·ªÉn th·ªã ·∫£nh tr∆∞·ªõc khi upload
document.getElementById("imgFile").addEventListener("change", function (event) {
    const file = event.target.files[0];
    const preview = document.getElementById("previewImage");

    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
        };
        reader.readAsDataURL(file);
    } else {
        preview.src = "";
        preview.style.display = "none";
    }
});

// L·∫•y avatar ng∆∞·ªùi d√πng hi·ªán t·∫°i v√† g√°n v√†o ph·∫ßn ƒëƒÉng b√†i
const token = localStorage.getItem("token");
if (token) {
    fetch("/v1/auth/info", {
        headers: { "Authorization": "Bearer " + token }
    })
    .then(res => res.json())
    .then(user => {
        document.getElementById("currentUserAvatar").src = user.avatarUrl || "/images/logo.jpg";
    });
}

function renderFollowings() {
    const token = localStorage.getItem("token");
    if (!token) return;
    fetch("/v1/profile/followings", {
        headers: { "Authorization": "Bearer " + token }
    })
    .then(res => res.json())
    .then(data => {
        const list = document.getElementById("followingsList");
        const users = data.data && data.data.data ? data.data.data : [];
        if (users.length === 0) {
            list.innerHTML = '<div style="color:#888;">B·∫°n ch∆∞a follow ai.</div>';
            return;
        }
        list.innerHTML = users.map(user => `
            <div class="contact-item" style="display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer;border-radius:6px;transition:background 0.2s;" onclick="openChatModalWith('${user.nickName}','${user.avatarUrl || '/images/logo.jpg'}','${user.id}')">
                <img src="${user.avatarUrl || '/images/logo.jpg'}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">
                <span style="font-weight:500;">${user.nickName}</span>
            </div>
        `).join('');
    });
}
renderFollowings();

// H√†m m·ªü modal chat v·ªõi ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn
function openChatModalWith(nickName, avatarUrl, userId) {
    document.getElementById('chatModal').style.display = 'none';
    document.getElementById('chatDetailModal').style.display = 'block';
    document.getElementById('chatWithName').innerText = nickName;
    document.getElementById('chatHeaderAvatar').src = avatarUrl || '/images/logo.jpg';
    if (window.loadChatHistory) window.loadChatHistory(userId, avatarUrl);
    if (window.setCurrentChatUserId) window.setCurrentChatUserId(userId);
}
// Th√™m ƒëo·∫°n m√£ n√†y v√†o cu·ªëi th·∫ª <script> trong home.html
// Ho·∫∑c t·ªët h∆°n l√† ƒë·∫∑t n√≥ v√†o file /js/profile.js

document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logoutBtn');

    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            // X√≥a token v√† userId kh·ªèi Local Storage
            localStorage.removeItem('token');
            localStorage.removeItem('userId');

            // Chuy·ªÉn h∆∞·ªõng ng∆∞·ªùi d√πng v·ªÅ trang ƒëƒÉng nh·∫≠p
            window.location.href = '/login'; // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n n√†y ƒë√∫ng v·ªõi trang ƒëƒÉng nh·∫≠p c·ªßa b·∫°n
        });
    }
});
    // Logic ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† hi·ªÉn th·ªã n√∫t
    document.addEventListener('DOMContentLoaded', function() {
    const authNavButtonContainer = document.getElementById('authNavButton');
    const token = localStorage.getItem('token');

    if (token) {
    // N·∫øu c√≥ token, hi·ªÉn th·ªã n√∫t Profile v√† dropdown
    authNavButtonContainer.innerHTML = `
            <button id="openProfileDropdown">üë§ Profile</button>
            <div id="profileDropdownMenu" class="profile-dropdown-menu">
                <div class="dropdown-item" id="viewProfileBtn"><i class="bi bi-person-circle"></i> Xem t·∫•t c·∫£ trang c√° nh√¢n</div>
                <hr />
                <div class="dropdown-item"><i class="bi bi-gear-fill"></i> C√†i ƒë·∫∑t & quy·ªÅn ri√™ng t∆∞</div>
                <div class="dropdown-item"><i class="bi bi-question-circle-fill"></i> Tr·ª£ gi√∫p v√† h·ªó tr·ª£</div>
                <div class="dropdown-item"><i class="bi bi-moon-fill"></i> M√†n h√¨nh & tr·ª£ nƒÉng</div>
                <div class="dropdown-item"><i class="bi bi-chat-dots-fill"></i> ƒê√≥ng g√≥p √Ω ki·∫øn</div>
                <hr />
                <div class="dropdown-item" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t</div>
            </div>
        `;

    const openProfileDropdownBtn = document.getElementById('openProfileDropdown');
    const profileDropdownMenu = document.getElementById('profileDropdownMenu');
    const logoutBtn = document.getElementById('logoutBtn'); // L·∫•y l·∫°i n√∫t logout sau khi render

    // Toggle dropdown khi click n√∫t Profile
    openProfileDropdownBtn.addEventListener('click', function(event) {
    event.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan ra ngo√†i
    profileDropdownMenu.classList.toggle('show');
});

    // ƒê√≥ng dropdown khi click b√™n ngo√†i
    document.addEventListener('click', function(event) {
    if (!authNavButtonContainer.contains(event.target)) {
    profileDropdownMenu.classList.remove('show');
}
});

    // Logic ƒêƒÉng xu·∫•t
    if (logoutBtn) {
    logoutBtn.addEventListener('click', function() {
    localStorage.removeItem('token');
    localStorage.removeItem('userId');
    window.location.href = '/login'; // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
});
}

    // Logic "Xem t·∫•t c·∫£ trang c√° nh√¢n" (n·∫øu c√≥ trang profile ri√™ng)
        const viewProfileBtnDropdown = document.getElementById('viewProfileBtn'); // Gi·ªØ nguy√™n ID n·∫øu b·∫°n mu·ªën
        if (viewProfileBtnDropdown) { // S·ª≠ d·ª•ng ID ph√π h·ª£p v·ªõi dropdown item
            viewProfileBtnDropdown.addEventListener('click', function() {
                const currentUserId = localStorage.getItem('userId');
                if (currentUserId) {
                    // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang profile.html v√† truy·ªÅn userId qua URL param
                    window.location.href = `/profile?userId=${currentUserId}`;
                } else {
                    alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng.');
                }
                // N·∫øu profileDropdownMenu ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong scope n√†y, ƒë√≥ng n√≥
                if (typeof profileDropdownMenu !== 'undefined') {
                    profileDropdownMenu.classList.remove('show');
                }
            });
        }


    } else {
    // N·∫øu kh√¥ng c√≥ token, hi·ªÉn th·ªã n√∫t Login
    authNavButtonContainer.innerHTML = '<a href="/login" class="nav-item-link">üîì Login</a>';
}

    // --- C√°c script hi·ªán c√≥ c·ªßa b·∫°n (ƒë√£ ƒë∆∞·ª£c bao b·ªçc trong DOMContentLoaded) ---

    // hi·ªÉn th·ªã ·∫£nh tr∆∞·ªõc khi upload
    document.getElementById("imgFile").addEventListener("change", function (event) {
    const file = event.target.files[0];
    const preview = document.getElementById("previewImage");

    if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
    preview.src = e.target.result;
    preview.style.display = "block";
};
    reader.readAsDataURL(file);
} else {
    preview.src = "";
    preview.style.display = "none";
}
});

    // L·∫•y avatar ng∆∞·ªùi d√πng hi·ªán t·∫°i v√† g√°n v√†o ph·∫ßn ƒëƒÉng b√†i (ch·ªâ khi c√≥ token)
    if (token) {
    fetch("/v1/auth/info", {
    headers: { "Authorization": "Bearer " + token }
})
    .then(res => res.json())
    .then(user => {
    document.getElementById("currentUserAvatar").src = user.avatarUrl || "/images/logo.jpg";
})
    .catch(error => {
    console.error("Error fetching user info:", error);
    // C√≥ th·ªÉ x·ª≠ l√Ω l·ªói ·ªü ƒë√¢y, v√≠ d·ª•: chuy·ªÉn h∆∞·ªõng v·ªÅ login n·∫øu token kh√¥ng h·ª£p l·ªá
    // localStorage.removeItem('token');
    // localStorage.removeItem('userId');
    // window.location.href = '/login';
});
} else {
    // N·∫øu kh√¥ng c√≥ token, ·∫©n ho·∫∑c thay th·∫ø ph·∫ßn ƒëƒÉng b√†i n·∫øu c·∫ßn
    const postForm = document.getElementById("postForm");
    if (postForm) {
     postForm.style.display = 'none'; // ·∫®n form ƒëƒÉng b√†i
    // Ho·∫∑c chuy·ªÉn h∆∞·ªõng n·∫øu ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p m√† v√†o trang home
    // window.location.href = '/login';
}
    const currentUserAvatar = document.getElementById("currentUserAvatar");
    if (currentUserAvatar) {
    currentUserAvatar.src = "/images/logo.jpg"; // Set default avatar
}
}


    function renderFollowings() {
    const token = localStorage.getItem("token");
    if (!token) {
    const list = document.getElementById("followingsList");
    if (list) list.innerHTML = '<div style="color:#888;">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ng∆∞·ªùi li√™n h·ªá.</div>';
    return;
}
    fetch("/v1/profile/followings", {
    headers: { "Authorization": "Bearer " + token }
})
    .then(res => {
    if (!res.ok) {
    if (res.status === 401 || res.status === 403) {
    localStorage.removeItem('token');
    localStorage.removeItem('userId');
    alert('Phi√™n l√†m vi·ªác ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
    window.location.href = '/login';
}
    throw new Error('Failed to fetch followings');
}
    return res.json();
})
    .then(data => {
    const list = document.getElementById("followingsList");
    const users = data.data && data.data.data ? data.data.data : [];
    if (users.length === 0) {
    list.innerHTML = '<div style="color:#888;">B·∫°n ch∆∞a follow ai.</div>';
    return;
}
    list.innerHTML = users.map(user => `
                <div class="contact-item" style="display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer;border-radius:6px;transition:background 0.2s;" onclick="openChatModalWith('${user.nickName}','${user.avatarUrl || '/images/logo.jpg'}','${user.id}')">
                    <img src="${user.avatarUrl || '/images/logo.jpg'}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">
                    <span style="font-weight:500;">${user.nickName}</span>
                </div>
            `).join('');
})
    .catch(error => {
    console.error("Error rendering followings:", error);
    const list = document.getElementById("followingsList");
    if (list) list.innerHTML = '<div style="color:#888;">Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi li√™n h·ªá.</div>';
});
}
    renderFollowings();

    // H√†m m·ªü modal chat v·ªõi ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn
    function openChatModalWith(nickName, avatarUrl, userId) {
    document.getElementById('chatModal').style.display = 'none';
    document.getElementById('chatDetailModal').style.display = 'flex'; // D√πng flex ƒë·ªÉ cƒÉn gi·ªØa modal
    document.getElementById('chatWithName').innerText = nickName;
    document.getElementById('chatHeaderAvatar').src = avatarUrl || '/images/logo.jpg';
    if (window.loadChatHistory) window.loadChatHistory(userId, avatarUrl);
    if (window.setCurrentChatUserId) window.setCurrentChatUserId(userId);
}
    // G√°n h√†m v√†o window ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ onclick trong HTML
    window.openChatModalWith = openChatModalWith;

    // Logic ƒë√≥ng modal chat detail
    const chatDetailModal = document.getElementById('chatDetailModal');
    const closeDetailSpan = document.querySelector('#chatDetailModal .closeDetail');
    if (closeDetailSpan) {
    closeDetailSpan.onclick = function() {
    chatDetailModal.style.display = 'none';
}
}
    // `window.onclick` ƒë√£ ƒë∆∞·ª£c th√™m b√™n ngo√†i `DOMContentLoaded` tr∆∞·ªõc ƒë√≥, c·∫ßn ƒëi·ªÅu ch·ªânh ƒë·ªÉ kh√¥ng xung ƒë·ªôt.
    // N·∫øu b·∫°n mu·ªën ƒë√≥ng modal khi click b√™n ngo√†i, ch·ªâ n√™n c√≥ m·ªôt `window.onclick` duy nh·∫•t.
    // Hi·ªán t·∫°i, n√≥ ƒë√£ ƒë∆∞·ª£c chuy·ªÉn v√†o trong `DOMContentLoaded` v√† t√°ch ri√™ng cho m·ªói modal.

    // Logic m·ªü/ƒë√≥ng modal Messages
    const openModalBtn = document.getElementById('openModalBtn');
    const chatModal = document.getElementById('chatModal');
    const closeChatModalSpan = document.querySelector('#chatModal .close');

    if(openModalBtn) {
    openModalBtn.onclick = function() {
    chatModal.style.display = 'flex'; // D√πng flex ƒë·ªÉ cƒÉn gi·ªØa modal
}
}
    if(closeChatModalSpan) {
    closeChatModalSpan.onclick = function() {
    chatModal.style.display = 'none';
}
}
    // `window.onclick` cho chatModal
    window.onclick = function(event) {
    if (event.target === chatModal) {
    chatModal.style.display = 'none';
}
    // Th√™m ƒëi·ªÅu ki·ªán cho chatDetailModal v√†o ƒë√¢y n·∫øu mu·ªën m·ªôt `window.onclick` duy nh·∫•t
    if (event.target === chatDetailModal) {
    chatDetailModal.style.display = 'none';
}
}

    // Logic ƒë√≥ng modal Profile (kh√¥ng c·∫ßn n·ªØa v√¨ ƒë√£ thay b·∫±ng dropdown)
    // const profileModal = document.getElementById('profileModal');
    // const closeProfileSpan = document.querySelector('#profileModal .closeProfile');
    // if(closeProfileSpan) {
    //     closeProfileSpan.onclick = function() {
    //         profileModal.style.display = 'none';
    //     }
    // }
});

</script>
<style>

</style>
</body>
</html>
